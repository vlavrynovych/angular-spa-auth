{"version":3,"sources":["../src/angular-spa-auth.js","../node_modules/string.prototype.startswith/startswith.js"],"names":["MESSAGES","UNAUTHORIZED_REDIRECT_TO_LOGIN","MISSING_CURRENT_USER_ENDPOINT","MISSING_LOGIN_ENDPOINT","MISSING_LOGOUT_ENDPOINT","SUCCESS_AUTH","ERROR_OCCURS","CANNOT_OVERRIDE_CORE","angular","module","run","$rootScope","$location","$timeout","AuthService","saveTarget","$on","event","next","isAuthenticated","console","info","path","$$route","isPublic","originalPath","preventDefault","openLogin","service","$q","$http","message","config","verbose","goTo","route","endpoints","get","then","response","isAuth","JSON","parse","data","reject","resolve","init","refreshCurrentUser","handlers","success","error","uiRoutes","login","publicUrls","currentUser","logout","home","target","getHomePage","user","getUser","Error","stringify","credentials","post","err","mixins","url","some","publicUrl","startsWith","openTarget","clearTarget","openHome","getCurrentUser","configuration","merge","prop","hasOwnProperty","String","prototype","defineProperty","object","$defineProperty","Object","result","toString","search","this","TypeError","string","call","stringLength","length","searchString","searchLength","position","arguments","undefined","pos","Number","start","Math","min","max","index","charCodeAt","value","configurable","writable"],"mappings":"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","file":"angular-spa-auth.min.js","sourcesContent":["'use strict';\n(function () {\n\n    var MESSAGES = {\n        UNAUTHORIZED_REDIRECT_TO_LOGIN: 'Unauthorized: redirecting to the login page',\n        MISSING_CURRENT_USER_ENDPOINT: 'Endpoint for current user is not specified',\n        MISSING_LOGIN_ENDPOINT: 'Login endpoint is not specified',\n        MISSING_LOGOUT_ENDPOINT: 'Logout endpoint is not specified',\n        SUCCESS_AUTH: 'Successfully authenticated',\n        ERROR_OCCURS: 'Error occurs',\n        CANNOT_OVERRIDE_CORE: 'You cannot override core service methods. Please use handlers to customize your auth process: '\n    };\n\n    angular.module('angular-spa-auth', ['ngRoute'])\n        .run(['$rootScope', '$location', '$timeout', 'AuthService', function ($rootScope, $location, $timeout, AuthService) {\n            AuthService.saveTarget();\n            $rootScope.$on('$routeChangeStart', function (event, next) {\n                // if not logged yet then save target route\n                if ((!AuthService.isAuthenticated())) {\n                    if (next.$$route && !AuthService.isPublic(next.$$route.originalPath)) {\n                        event.preventDefault();\n                        $timeout(function () {\n                            console.info(MESSAGES.UNAUTHORIZED_REDIRECT_TO_LOGIN);\n                            AuthService.openLogin();\n                        });\n                    }\n                } else {\n                    console.info('Loading ' + $location.path());\n                }\n            });\n        }])\n        .service('AuthService', ['$rootScope', '$q', '$http', '$location', function ($rootScope, $q, $http, $location) {\n\n            // ------------------------------------------------------------------------/// Config\n            var config = {\n                verbose: false,\n                publicUrls: ['/login', '/home'],\n                endpoints: {\n                    isAuthenticated: null,\n                    currentUser: null,\n                    logout: '/logout',\n                    login: '/login'\n                },\n                uiRoutes: {\n                    login: '/login',\n                    home: '/home',\n                    target: null\n                },\n                handlers: {\n                    /**\n                     * Returns url of home page as a string\n                     * @param {Object} user authenticated user\n                     * @returns {string} url to the default/home page\n                     */\n                    getHomePage: function(user) {\n                        return config.uiRoutes.home;\n                    },\n\n                    /**\n                     * Returns promise of GET request which should get current user from backend\n                     * @returns {Promise}\n                     */\n                    getUser: function () {\n                        if(!config.endpoints.currentUser) {\n                            throw new Error(MESSAGES.MISSING_CURRENT_USER_ENDPOINT)\n                        }\n\n                        return $http.get(config.endpoints.currentUser).then(function (response) {\n                            info('current user: ' + JSON.stringify(response.data));\n                            return response.data\n                        })\n                    },\n\n                    /**\n                     * Tries to login user using provided credentials.\n                     * Sends GET request\n                     *\n                     * @param {Object} credentials object with user credentials\n                     * @param {String} [credentials.login]\n                     * @param {String} [credentials.password]\n                     * @returns {Promise}\n                     */\n                    login: function (credentials) {\n                        if(!config.endpoints.login) {\n                            throw new Error(MESSAGES.MISSING_LOGIN_ENDPOINT)\n                        }\n\n                        return $http.post(config.endpoints.login, credentials)\n                    },\n\n                    logout: function () {\n                        if(!config.endpoints.logout) {\n                            throw new Error(MESSAGES.MISSING_LOGOUT_ENDPOINT)\n                        }\n\n                        return $http.get(config.endpoints.logout).then(function () {\n                            $rootScope.currentUser = null;\n                            openLogin();\n                        }, function (err) {\n                            console.error(err);\n                        });\n                    },\n\n                    /**\n                     * Success handler\n                     * @param {*} data received from backend\n                     */\n                    success: function (data) {\n                        info(MESSAGES.SUCCESS_AUTH)\n                    },\n\n                    /**\n                     * Error handler\n                     * @param {*} err backend error object\n                     */\n                    error: function (err) {\n                        if(config.verbose) {\n                            console.error(MESSAGES.ERROR_OCCURS, err)\n                        }\n                    }\n                },\n                mixins: {}\n            };\n\n            // ------------------------------------------------------------------------/// Private\n            function info(message) {\n                if(config.verbose) {\n                    console.info(message)\n                }\n            }\n\n            function goTo(route) {\n                $location.path(route);\n            }\n\n            function isAuthenticated() {\n                if (!config.endpoints.isAuthenticated) {\n                    return $q(function (resolve, reject) {\n                        resolve(true)\n                    });\n                }\n\n                return $http.get(config.endpoints.isAuthenticated).then(function (response) {\n                    var isAuth = JSON.parse(response.data);\n                    info('isAuthenticated: ' + isAuth);\n                    return isAuth || $q.reject(response.data);\n                });\n            }\n\n            function init() {\n                isAuthenticated().then(function () {\n                    service.refreshCurrentUser()\n                        .then(config.handlers.success, config.handlers.error)\n                        .catch(openLogin);\n                })\n            }\n\n            function openLogin() {\n                goTo(config.uiRoutes.login);\n            }\n\n            // ------------------------------------------------------------------------/// Public\n            var service = {\n                config: config,\n\n                /**\n                 * Returns true if provide route url is in the list of public urls\n                 * @param {String} url route path that should be checked\n                 * @returns {boolean} true if url is in the list of public urls\n                 */\n                isPublic: function (url) {\n                    return config.publicUrls.some(function (publicUrl) {\n                        return url && publicUrl.startsWith(url);\n                    });\n                },\n                /**\n                 * Saves current route as a target route\n                 */\n                saveTarget: function () {\n                    config.uiRoutes.target = $location.path();\n                    info('Target route is saved: ' + config.uiRoutes.target);\n                },\n                /**\n                 * Redirects user to the saved target route if exists or to the home page\n                 */\n                openTarget: function () {\n                    config.uiRoutes.target = config.uiRoutes.target || config.handlers.getHomePage($rootScope.currentUser);\n                    goTo(config.uiRoutes.target);\n                    info('Redirected to the target route: ' + config.uiRoutes.target);\n                    service.clearTarget()\n                },\n                /**\n                 * Clears saved target route\n                 */\n                clearTarget: function () {\n                    config.uiRoutes.target = null;\n                },\n                /**\n                 * Redirects user to the login page\n                 */\n                openLogin: openLogin,\n                /**\n                 * Redirects user to the home page\n                 */\n                openHome: function () {\n                    goTo(config.handlers.getHomePage($rootScope.currentUser));\n                },\n                /**\n                 * Returns saved current user or load it from backed\n                 * Always returns {Promise}\n                 * @returns {Promise}\n                 */\n                getCurrentUser: function () {\n                    return $rootScope.currentUser ? $rootScope.currentUser : service.refreshCurrentUser();\n                },\n                /**\n                 * Loads user from backed using currentUser endpoint or getUser handler\n                 * Always returns {Promise}\n                 * @returns {Promise}\n                 */\n                refreshCurrentUser: function() {\n                    return config.handlers.getUser().then(function (user) {\n                        $rootScope.currentUser = user;\n                        service.openTarget();\n                        return user;\n                    })\n                },\n                /**\n                 * Returns true if user is authenticated\n                 * Warning! It does not check backend.\n                 * @returns {boolean} true if user is authenticated\n                 */\n                isAuthenticated: function () {\n                    return !!$rootScope.currentUser;\n                },\n                /**\n                 * Logs user out from the system and redirects it to the login page\n                 */\n                logout: function () {\n                    return config.handlers.logout();\n                },\n                /**\n                 * Allows you to configure angular-spa-auth module and start the init process.\n                 * Should be called in the #run method of you module\n                 * @param {Object} configuration contains all the configs\n                 * @param {String=} configuration.verbose activates console.info output if true\n                 * @param {String[]=} configuration.publicUrls list url that are available for unauthorized users\n                 * @param {Object=} configuration.endpoints gives you ability to setup all the backed endpoints that will own roles in the authentication process\n                 * @param {Object=} configuration.uiRoutes helps you automatically redirect user to the specified UI routes such as home and login\n                 * @param {String=} configuration.uiRoutes.home home route\n                 * @param {String=} configuration.uiRoutes.login login route\n                 * @param {Object=} configuration.handlers allows you to provide you implementation for key methods of authentication process\n                 * @param {Object=} configuration.mixins allows you to extend AuthService\n                 */\n                run: function (configuration) {\n                    if (configuration) {\n                        config = angular.merge(config, configuration);\n\n                        if (configuration.mixins) {\n                            for(var prop in configuration.mixins) {\n                                if(service.hasOwnProperty(prop)){\n                                    throw new Error(MESSAGES.CANNOT_OVERRIDE_CORE + prop)\n                                }\n                            }\n\n                            angular.merge(service, configuration.mixins);\n                        }\n                    }\n                    init()\n                },\n                /**\n                 * Login user using provided credentials\n                 * @param {Object} credentials object with any type of information that is needed to compelete authentication process\n                 */\n                login: function (credentials) {\n                    config.handlers.login(credentials)\n                        .then(service.refreshCurrentUser)\n                        .then(config.handlers.success)\n                        .catch(config.handlers.error);\n                }\n            };\n\n            return service\n        }]);\n})();","/*! http://mths.be/startswith v0.2.0 by @mathias */\nif (!String.prototype.startsWith) {\n\t(function() {\n\t\t'use strict'; // needed to support `apply`/`call` with `undefined`/`null`\n\t\tvar defineProperty = (function() {\n\t\t\t// IE 8 only supports `Object.defineProperty` on DOM elements\n\t\t\ttry {\n\t\t\t\tvar object = {};\n\t\t\t\tvar $defineProperty = Object.defineProperty;\n\t\t\t\tvar result = $defineProperty(object, object, object) && $defineProperty;\n\t\t\t} catch(error) {}\n\t\t\treturn result;\n\t\t}());\n\t\tvar toString = {}.toString;\n\t\tvar startsWith = function(search) {\n\t\t\tif (this == null) {\n\t\t\t\tthrow TypeError();\n\t\t\t}\n\t\t\tvar string = String(this);\n\t\t\tif (search && toString.call(search) == '[object RegExp]') {\n\t\t\t\tthrow TypeError();\n\t\t\t}\n\t\t\tvar stringLength = string.length;\n\t\t\tvar searchString = String(search);\n\t\t\tvar searchLength = searchString.length;\n\t\t\tvar position = arguments.length > 1 ? arguments[1] : undefined;\n\t\t\t// `ToInteger`\n\t\t\tvar pos = position ? Number(position) : 0;\n\t\t\tif (pos != pos) { // better `isNaN`\n\t\t\t\tpos = 0;\n\t\t\t}\n\t\t\tvar start = Math.min(Math.max(pos, 0), stringLength);\n\t\t\t// Avoid the `indexOf` call if no match is possible\n\t\t\tif (searchLength + start > stringLength) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tvar index = -1;\n\t\t\twhile (++index < searchLength) {\n\t\t\t\tif (string.charCodeAt(start + index) != searchString.charCodeAt(index)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t};\n\t\tif (defineProperty) {\n\t\t\tdefineProperty(String.prototype, 'startsWith', {\n\t\t\t\t'value': startsWith,\n\t\t\t\t'configurable': true,\n\t\t\t\t'writable': true\n\t\t\t});\n\t\t} else {\n\t\t\tString.prototype.startsWith = startsWith;\n\t\t}\n\t}());\n}\n"]}