{"version":3,"sources":["../src/angular-spa-auth.js"],"names":["MESSAGES","UNAUTHORIZED_REDIRECT_TO_LOGIN","MISSING_CURRENT_USER_ENDPOINT","MISSING_LOGIN_ENDPOINT","SUCCESS_AUTH","ERROR_OCCURS","CANNOT_OVERRIDE_CORE","angular","module","run","$rootScope","$location","$timeout","AuthService","saveTarget","$on","event","next","isAuthenticated","console","info","path","$$route","isPublic","originalPath","preventDefault","openLogin","service","$q","$http","message","config","verbose","goTo","route","endpoints","get","then","response","isAuth","JSON","parse","data","reject","resolve","init","refreshCurrentUser","handlers","success","error","uiRoutes","login","publicUrls","currentUser","logout","home","target","getHomePage","user","getUser","Error","stringify","credentials","post","err","mixins","url","some","publicUrl","indexOf","openTarget","clearTarget","openHome","getCurrentUser","configuration","merge","prop","hasOwnProperty"],"mappings":"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","file":"angular-spa-auth.min.js","sourcesContent":["'use strict';\n(function () {\n\n    var MESSAGES = {\n        UNAUTHORIZED_REDIRECT_TO_LOGIN: 'Unauthorized: redirecting to the login page',\n        MISSING_CURRENT_USER_ENDPOINT: 'Endpoint for current user is not specified',\n        MISSING_LOGIN_ENDPOINT: 'Login endpoint is not specified',\n        SUCCESS_AUTH: 'Successfully authenticated',\n        ERROR_OCCURS: 'Error occurs',\n        CANNOT_OVERRIDE_CORE: 'You cannot override core service methods. Please use handlers to customize your auth process: '\n    };\n\n    angular.module('angular-spa-auth', ['ngRoute'])\n        .run(['$rootScope', '$location', '$timeout', 'AuthService', function ($rootScope, $location, $timeout, AuthService) {\n            AuthService.saveTarget();\n            $rootScope.$on('$routeChangeStart', function (event, next) {\n                // if not logged yet then save target route\n                if ((!AuthService.isAuthenticated())) {\n                    if (next.$$route && !AuthService.isPublic(next.$$route.originalPath)) {\n                        event.preventDefault();\n                        $timeout(function () {\n                            console.info(MESSAGES.UNAUTHORIZED_REDIRECT_TO_LOGIN);\n                            AuthService.openLogin();\n                        });\n                    }\n                } else {\n                    console.info('Loading ' + $location.path());\n                }\n            });\n        }])\n        .service('AuthService', ['$rootScope', '$q', '$http', '$location', function ($rootScope, $q, $http, $location) {\n\n            // ------------------------------------------------------------------------/// Config\n            var config = {\n                verbose: false,\n                publicUrls: ['/login', '/home'],\n                endpoints: {\n                    isAuthenticated: null,\n                    currentUser: null,\n                    logout: '/logout',\n                    login: '/login'\n                },\n                uiRoutes: {\n                    login: '/login',\n                    home: '/home',\n                    target: null\n                },\n                handlers: {\n                    /**\n                     * Returns url of home page as a string\n                     * @param {Object} user authenticated user\n                     * @returns {string} url to the default/home page\n                     */\n                    getHomePage: function(user) {\n                        return config.uiRoutes.home;\n                    },\n\n                    /**\n                     * Returns promise of GET request which should get current user from backend\n                     * @returns {Promise}\n                     */\n                    getUser: function () {\n                        if(!config.endpoints.currentUser) {\n                            throw new Error(MESSAGES.MISSING_CURRENT_USER_ENDPOINT)\n                        }\n\n                        return $http.get(config.endpoints.currentUser).then(function (response) {\n                            info('current user: ' + JSON.stringify(response.data));\n                            return response.data\n                        })\n                    },\n\n                    /**\n                     * Tries to login user using provided credentials.\n                     * Sends GET request\n                     *\n                     * @param {Object} credentials object with user credentials\n                     * @param {String} [credentials.login]\n                     * @param {String} [credentials.password]\n                     * @returns {Promise}\n                     */\n                    login: function (credentials) {\n                        if(!config.endpoints.login) {\n                            throw new Error(MESSAGES.MISSING_LOGIN_ENDPOINT)\n                        }\n\n                        return $http.post(config.endpoints.login, credentials)\n                    },\n\n                    /**\n                     * Success handler\n                     * @param {*} data received from backend\n                     */\n                    success: function (data) {\n                        info(MESSAGES.SUCCESS_AUTH)\n                    },\n\n                    /**\n                     * Error handler\n                     * @param {*} err backend error object\n                     */\n                    error: function (err) {\n                        if(config.verbose) {\n                            console.error(MESSAGES.ERROR_OCCURS, err)\n                        }\n                    }\n                },\n                mixins: {}\n            };\n\n            // ------------------------------------------------------------------------/// Private\n            function info(message) {\n                if(config.verbose) {\n                    console.info(message)\n                }\n            }\n\n            function goTo(route) {\n                $location.path(route);\n            }\n\n            function isAuthenticated() {\n                if (!config.endpoints.isAuthenticated) {\n                    return $q(function (resolve, reject) {\n                        resolve(true)\n                    });\n                }\n\n                return $http.get(config.endpoints.isAuthenticated).then(function (response) {\n                    var isAuth = JSON.parse(response.data);\n                    info('isAuthenticated: ' + isAuth);\n                    return isAuth || $q.reject(response.data);\n                });\n            }\n\n            function init() {\n                isAuthenticated().then(function () {\n                    service.refreshCurrentUser()\n                        .then(config.handlers.success, config.handlers.error)\n                        .catch(openLogin);\n                })\n            }\n\n            function openLogin() {\n                goTo(config.uiRoutes.login);\n            }\n\n            // ------------------------------------------------------------------------/// Public\n            var service = {\n                /**\n                 * Returns true if provide route url is in the list of public urls\n                 * @param {String} url route path that should be checked\n                 * @returns {boolean} true if url is in the list of public urls\n                 */\n                isPublic: function (url) {\n                    return config.publicUrls.some(function (publicUrl) {\n                        return url.indexOf(publicUrl) > -1;\n                    });\n                },\n                /**\n                 * Saves current route as a target route\n                 */\n                saveTarget: function () {\n                    config.uiRoutes.target = $location.path();\n                    info('Target route is saved: ' + config.uiRoutes.target);\n                },\n                /**\n                 * Redirects user to the saved target route if exists or to the home page\n                 */\n                openTarget: function () {\n                    config.uiRoutes.target = config.uiRoutes.target || config.handlers.getHomePage($rootScope.currentUser);\n                    goTo(config.uiRoutes.target);\n                    info('Redirected to the target route: ' + config.uiRoutes.target);\n                    service.clearTarget()\n                },\n                /**\n                 * Clears saved target route\n                 */\n                clearTarget: function () {\n                    config.uiRoutes.target = null;\n                },\n                /**\n                 * Redirects user to the login page\n                 */\n                openLogin: openLogin,\n                /**\n                 * Redirects user to the home page\n                 */\n                openHome: function () {\n                    goTo(config.handlers.getHomePage($rootScope.currentUser));\n                },\n                /**\n                 * Returns saved current user or load it from backed\n                 * Always returns {Promise}\n                 * @returns {Promise}\n                 */\n                getCurrentUser: function () {\n                    return $rootScope.currentUser ? $rootScope.currentUser : service.refreshCurrentUser();\n                },\n                /**\n                 * Loads user from backed using currentUser endpoint or getUser handler\n                 * Always returns {Promise}\n                 * @returns {Promise}\n                 */\n                refreshCurrentUser: function() {\n                    return config.handlers.getUser().then(function (user) {\n                        $rootScope.currentUser = user;\n                        service.openTarget();\n                        return user;\n                    })\n                },\n                /**\n                 * Returns true if user is authenticated\n                 * Warning! It does not check backend.\n                 * @returns {boolean} true if user is authenticated\n                 */\n                isAuthenticated: function () {\n                    return !!$rootScope.currentUser;\n                },\n                /**\n                 * Logs user out from the system and redirects it to the login page\n                 */\n                logout: function () {\n                    $http.get(config.endpoints.logout).then(function () {\n                        $rootScope.currentUser = null;\n                        openLogin();\n                    });\n                },\n                /**\n                 * Allows you to configure angular-spa-auth module and start the init process.\n                 * Should be called in the #run method of you module\n                 * @param {Object} configuration contains all the configs\n                 * @param {String=} configuration.verbose activates console.info output if true\n                 * @param {String[]=} configuration.publicUrls list url that are available for unauthorized users\n                 * @param {Object=} configuration.endpoints gives you ability to setup all the backed endpoints that will own roles in the authentication process\n                 * @param {Object=} configuration.uiRoutes helps you automatically redirect user to the specified UI routes such as home and login\n                 * @param {String=} configuration.uiRoutes.home home route\n                 * @param {String=} configuration.uiRoutes.login login route\n                 * @param {Object=} configuration.handlers allows you to provide you implementation for key methods of authentication process\n                 * @param {Object=} configuration.mixins allows you to extend AuthService\n                 */\n                run: function (configuration) {\n                    if (configuration) {\n                        config = angular.merge(config, configuration);\n\n                        if (configuration.mixins) {\n                            for(var prop in configuration.mixins) {\n                                if(service.hasOwnProperty(prop)){\n                                    throw new Error(MESSAGES.CANNOT_OVERRIDE_CORE + prop)\n                                }\n                            }\n\n                            angular.merge(service, configuration.mixins);\n                        }\n                    }\n                    init()\n                },\n                /**\n                 * Login user using provided credentials\n                 * @param {Object} credentials object with any type of information that is needed to compelete authentication process\n                 */\n                login: function (credentials) {\n                    config.handlers.login(credentials)\n                        .then(service.refreshCurrentUser)\n                        .then(config.handlers.success)\n                        .catch(config.handlers.error);\n                }\n            };\n\n            return service\n        }]);\n})();"]}