"use strict";!function(){var t={UNAUTHORIZED_REDIRECT_TO_LOGIN:"Unauthorized: redirecting to the login page",MISSING_CURRENT_USER_ENDPOINT:"Endpoint for current user is not specified",MISSING_LOGIN_ENDPOINT:"Login endpoint is not specified",MISSING_LOGOUT_ENDPOINT:"Logout endpoint is not specified",SUCCESS_AUTH:"Successfully authenticated"};angular.module("angular-spa-auth",["ngRoute"]).run(["$rootScope","$location","AuthService",function(n,e,r){function o(){return void 0!==n.currentUser}r.saveTarget(),n.$on("$routeChangeStart",function(n,i){function u(){return i.$$route&&!r.isPublic(i.$$route.originalPath)}function c(){r._info("Stop loading: "+e.path()),n.preventDefault()}r._info("Start loading: "+e.path()),o()?r.isAuthenticated()?e.path()==r.config.uiRoutes.login&&(c(),r.openHome()):u()&&(c(),r._info(t.UNAUTHORIZED_REDIRECT_TO_LOGIN),r.openLogin()):u()&&(r._info("Unknown user status"),c())}),n.$on("$routeChangeSuccess",function(t,n){r._info("Loaded: "+e.path())})}]).service("AuthService",["$rootScope","$q","$http","$location",function(n,e,r,o){function i(t){c(console.info,t)}function u(t){c(console.error,t)}function c(t,n){p.verbose&&t&&t(n)}function s(t){o.path(t),i("Redirected to the "+t)}function a(){return p.endpoints.isAuthenticated?r.get(p.endpoints.isAuthenticated).then(function(t){var r=JSON.parse(t.data);return i("isAuthenticated: "+r),n.currentUser=t.data,r||e.reject(t.data)}):e.resolve(!0)}function l(){a().then(d.refreshCurrentUser).then(function(t){p.handlers.success(t)})["catch"](function(t){return f(),g(t)})}function f(){s(p.uiRoutes.login)}function g(t){return u(t),p.handlers.error(t),e.reject(t)}function h(){return p.handlers.getHomePage(n.currentUser)}var p={verbose:!1,publicUrls:["/login","/home"],endpoints:{isAuthenticated:null,currentUser:null,logout:"/logout",login:"/login"},uiRoutes:{login:"/login",home:"/home",target:null},handlers:{getHomePage:function(t){return p.uiRoutes.home},getUser:function(){if(!p.endpoints.currentUser)throw new Error(t.MISSING_CURRENT_USER_ENDPOINT);return r.get(p.endpoints.currentUser).then(function(t){return i("Current user: "+JSON.stringify(t.data)),t.data})},login:function(n){if(!p.endpoints.login)throw new Error(t.MISSING_LOGIN_ENDPOINT);return r.post(p.endpoints.login,n)},logout:function(){if(!p.endpoints.logout)throw new Error(t.MISSING_LOGOUT_ENDPOINT);return r.get(p.endpoints.logout).then(function(){n.currentUser=null,f()})},success:function(n){i(t.SUCCESS_AUTH)},error:u}},d={config:p,_info:i,isPublic:function(t){return t?p.publicUrls.some(function(n){return n instanceof RegExp?t.match(n):"string"==typeof n?t&&n.startsWith(t):!1}):!1},saveTarget:function(){p.uiRoutes.target=o.path()||null,i("Target route is saved: "+p.uiRoutes.target)},openTarget:function(){var t=p.uiRoutes.target||h();s(t),d.clearTarget()},clearTarget:function(){p.uiRoutes.target=null},openLogin:f,openHome:function(){s(h())},getCurrentUser:function(){return n.currentUser?e.resolve(n.currentUser):d.refreshCurrentUser()},refreshCurrentUser:function(){return p.handlers.getUser().then(function(t){return n.currentUser=t,d.openTarget(),n.currentUser})},isAuthenticated:function(){return!!n.currentUser},logout:function(){return p.handlers.logout()},run:function(t){t&&(t.publicUrls&&(p.publicUrls=t.publicUrls),p=angular.merge(p,t)),l()},login:function(t){return p.handlers.login(t).then(d.refreshCurrentUser).then(p.handlers.success)["catch"](g)}};return d}])}(),String.prototype.startsWith||!function(){var t=function(){try{var t={},n=Object.defineProperty,e=n(t,t,t)&&n}catch(r){}return e}(),n={}.toString,e=function(t){if(null==this)throw TypeError();var e=String(this);if(t&&"[object RegExp]"==n.call(t))throw TypeError();var r=e.length,o=String(t),i=o.length,u=arguments.length>1?arguments[1]:void 0,c=u?Number(u):0;c!=c&&(c=0);var s=Math.min(Math.max(c,0),r);if(i+s>r)return!1;for(var a=-1;++a<i;)if(e.charCodeAt(s+a)!=o.charCodeAt(a))return!1;return!0};t?t(String.prototype,"startsWith",{value:e,configurable:!0,writable:!0}):String.prototype.startsWith=e}();
//# sourceMappingURL=angular-spa-auth.min.js.map
