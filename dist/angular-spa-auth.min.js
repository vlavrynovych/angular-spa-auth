"use strict";!function(){var t={UNAUTHORIZED_REDIRECT_TO_LOGIN:"Unauthorized: redirecting to the login page",MISSING_CURRENT_USER_ENDPOINT:"Endpoint for current user is not specified",MISSING_LOGIN_ENDPOINT:"Login endpoint is not specified",MISSING_LOGOUT_ENDPOINT:"Logout endpoint is not specified",SUCCESS_AUTH:"Successfully authenticated"};angular.module("angular-spa-auth",["ngRoute"]).run(["$rootScope","$location","AuthService",function(e,n,r){function o(){return void 0!==e.currentUser}r.saveTarget(),e.$on("$routeChangeStart",function(e,i){function u(){return i.$$route&&!r.isPublic(i.$$route.originalPath)}function c(){r._info("Stop loading: "+n.path()),e.preventDefault()}r._info("Start loading: "+n.path()),o()?r.isAuthenticated()?n.path()==r.config.uiRoutes.login&&(c(),r.openHome()):u()&&(c(),r._info(t.UNAUTHORIZED_REDIRECT_TO_LOGIN),r.openLogin()):u()&&(r._info("Unknown user status"),c())}),e.$on("$routeChangeSuccess",function(t,e){r._info("Loaded: "+n.path())})}]).service("AuthService",["$rootScope","$q","$http","$location","$route",function(e,n,r,o,i){function u(t){s(console.info,"AuthService: "+t)}function c(t){s(console.error,t)}function s(t,e){d.verbose&&t&&t(e)}function a(t){u((o.path()||"unknown")+" -----> "+t),t==d.uiRoutes.login&&U.isAuthenticated()?(u("User is already authenticated and cannot open login page: "+t),t=p(),o.path(t),u("Redirected to the "+t)):t==o.path()?(u("Reload: "+t),i.reload()):(o.path(t),u("Redirected to the "+t))}function l(){return d.endpoints.isAuthenticated?r.get(d.endpoints.isAuthenticated).then(function(t){var r=JSON.parse(t.data);return u("isAuthenticated: "+r),e.currentUser=t.data,r||n.reject(t.data)}):n.resolve(!0)}function g(){u("init"),l().then(U.refreshCurrentUser).then(function(t){d.handlers.success(t)})["catch"](function(t){return h(),f(t)})}function h(){a(d.uiRoutes.login)}function f(t){return c(t),d.handlers.error(t),n.reject(t)}function p(){return d.handlers.getHomePage(e.currentUser)}var d={verbose:!1,publicUrls:["/login","/home"],endpoints:{isAuthenticated:null,currentUser:null,logout:"/logout",login:"/login"},uiRoutes:{login:"/login",home:"/home",target:null},handlers:{getHomePage:function(t){return d.uiRoutes.home},getUser:function(){if(!d.endpoints.currentUser)throw new Error(t.MISSING_CURRENT_USER_ENDPOINT);return r.get(d.endpoints.currentUser).then(function(t){return u("Current user: "+JSON.stringify(t.data)),t.data})},login:function(e){if(!d.endpoints.login)throw new Error(t.MISSING_LOGIN_ENDPOINT);return r.post(d.endpoints.login,e)},logout:function(){if(!d.endpoints.logout)throw new Error(t.MISSING_LOGOUT_ENDPOINT);return r.get(d.endpoints.logout).then(function(){e.currentUser=null,h()})},success:function(e){u(t.SUCCESS_AUTH)},error:c}},U={config:d,_info:u,isPublic:function(t){return t?d.publicUrls.some(function(e){return e instanceof RegExp?t.match(e):"string"==typeof e?t&&e.startsWith(t):!1}):!1},saveTarget:function(){d.uiRoutes.target=o.path()||null,u("Target route is saved: "+d.uiRoutes.target)},openTarget:function(){var t=d.uiRoutes.target||p();u("Open target: "+t),a(t),U.clearTarget()},clearTarget:function(){d.uiRoutes.target=null},openLogin:h,openHome:function(){a(p())},getCurrentUser:function(){return e.currentUser?n.resolve(e.currentUser):U.refreshCurrentUser()},refreshCurrentUser:function(){return d.handlers.getUser().then(function(t){return e.currentUser=t,U.openTarget(),e.currentUser})},isAuthenticated:function(){return!!e.currentUser},logout:function(){return d.handlers.logout()},run:function(t){t&&(t.publicUrls&&(d.publicUrls=t.publicUrls),d=angular.merge(d,t)),g()},login:function(t){return d.handlers.login(t).then(U.refreshCurrentUser).then(d.handlers.success)["catch"](f)}};return U}])}(),String.prototype.startsWith||!function(){var t=function(){try{var t={},e=Object.defineProperty,n=e(t,t,t)&&e}catch(r){}return n}(),e={}.toString,n=function(t){if(null==this)throw TypeError();var n=String(this);if(t&&"[object RegExp]"==e.call(t))throw TypeError();var r=n.length,o=String(t),i=o.length,u=arguments.length>1?arguments[1]:void 0,c=u?Number(u):0;c!=c&&(c=0);var s=Math.min(Math.max(c,0),r);if(i+s>r)return!1;for(var a=-1;++a<i;)if(n.charCodeAt(s+a)!=o.charCodeAt(a))return!1;return!0};t?t(String.prototype,"startsWith",{value:n,configurable:!0,writable:!0}):String.prototype.startsWith=n}();
//# sourceMappingURL=angular-spa-auth.min.js.map
